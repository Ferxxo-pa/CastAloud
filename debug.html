<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cast Aloud Debug</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .log { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007acc; }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { background: #007acc; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Cast Aloud Debug Console</h1>
    <div id="logs"></div>
    
    <button onclick="runDiagnostics()">Run Full Diagnostics</button>
    <button onclick="testReactApp()">Test React App</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <script>
        const logs = document.getElementById('logs');
        
        function addLog(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            logs.innerHTML = '';
        }
        
        async function runDiagnostics() {
            clearLogs();
            addLog('Starting comprehensive diagnostics...', 'log');
            
            // Test 1: Check main page HTML
            try {
                const response = await fetch('/', { cache: 'no-cache' });
                const html = await response.text();
                
                if (response.ok) {
                    addLog('✓ Main page loads (Status: ' + response.status + ')', 'success');
                    
                    if (html.includes('id="root"')) {
                        addLog('✓ Root div found in HTML', 'success');
                    } else {
                        addLog('✗ Root div NOT found in HTML', 'error');
                    }
                    
                    if (html.includes('main.tsx')) {
                        addLog('✓ React entry point referenced', 'success');
                    } else {
                        addLog('✗ React entry point NOT found', 'error');
                    }
                    
                    if (html.includes('vite')) {
                        addLog('✓ Vite development server active', 'success');
                    } else {
                        addLog('? Vite references not found (might be production)', 'warning');
                    }
                } else {
                    addLog('✗ Main page failed: ' + response.status, 'error');
                }
            } catch (error) {
                addLog('✗ Main page error: ' + error.message, 'error');
            }
            
            // Test 2: Check React entry point
            try {
                const response = await fetch('/src/main.tsx', { cache: 'no-cache' });
                if (response.ok) {
                    addLog('✓ React main.tsx accessible', 'success');
                } else {
                    addLog('✗ React main.tsx error: ' + response.status, 'error');
                }
            } catch (error) {
                addLog('✗ React main.tsx error: ' + error.message, 'error');
            }
            
            // Test 3: Check CSS
            try {
                const response = await fetch('/src/index.css', { cache: 'no-cache' });
                if (response.ok) {
                    addLog('✓ CSS file accessible', 'success');
                } else {
                    addLog('✗ CSS file error: ' + response.status, 'error');
                }
            } catch (error) {
                addLog('✗ CSS error: ' + error.message, 'error');
            }
            
            // Test 4: Service Worker status
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length > 0) {
                    addLog('⚠ Active service workers found: ' + registrations.length, 'warning');
                    registrations.forEach((reg, i) => {
                        addLog('SW ' + (i+1) + ': ' + reg.scope, 'warning');
                    });
                } else {
                    addLog('✓ No service workers registered', 'success');
                }
            }
            
            // Test 5: Cache status
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                if (cacheNames.length > 0) {
                    addLog('⚠ Browser caches found: ' + cacheNames.join(', '), 'warning');
                } else {
                    addLog('✓ No browser caches found', 'success');
                }
            }
            
            // Test 6: Browser console errors
            addLog('Checking for JavaScript errors...', 'log');
            
            // Test 7: Try to load React in an iframe to isolate issues
            addLog('Testing React app in isolated iframe...', 'log');
            const iframe = document.createElement('iframe');
            iframe.src = '/?debug=1';
            iframe.style.width = '300px';
            iframe.style.height = '200px';
            iframe.style.border = '1px solid #ccc';
            iframe.onload = () => {
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const root = iframeDoc.getElementById('root');
                        if (root && root.children.length > 0) {
                            addLog('✓ React app renders in iframe', 'success');
                        } else {
                            addLog('✗ React app NOT rendering in iframe', 'error');
                        }
                    } catch (e) {
                        addLog('✗ Cannot access iframe content: ' + e.message, 'error');
                    }
                }, 2000);
            };
            iframe.onerror = () => {
                addLog('✗ Iframe failed to load', 'error');
            };
            logs.appendChild(iframe);
            
            addLog('Diagnostics completed. Check results above.', 'log');
        }
        
        async function testReactApp() {
            addLog('Testing React app directly...', 'log');
            
            // Create a test container
            const testDiv = document.createElement('div');
            testDiv.id = 'test-root';
            testDiv.style.width = '100%';
            testDiv.style.height = '200px';
            testDiv.style.border = '2px solid #007acc';
            testDiv.style.margin = '10px 0';
            testDiv.style.padding = '10px';
            testDiv.innerHTML = 'Loading React test...';
            logs.appendChild(testDiv);
            
            // Try to dynamically import and render a simple React component
            try {
                const script = document.createElement('script');
                script.type = 'module';
                script.textContent = \`
                    import React from '/node_modules/react/index.js';
                    import ReactDOM from '/node_modules/react-dom/client/index.js';
                    
                    const testRoot = document.getElementById('test-root');
                    if (testRoot) {
                        const root = ReactDOM.createRoot(testRoot);
                        root.render(React.createElement('div', {
                            style: { color: 'green', fontWeight: 'bold' }
                        }, 'React is working!'));
                        console.log('React test successful');
                    }
                \`;
                document.head.appendChild(script);
                
                setTimeout(() => {
                    if (testDiv.innerHTML.includes('React is working!')) {
                        addLog('✓ React renders successfully', 'success');
                    } else {
                        addLog('✗ React failed to render', 'error');
                    }
                }, 1000);
                
            } catch (error) {
                addLog('✗ React test error: ' + error.message, 'error');
            }
        }
        
        // Capture console errors
        const originalError = console.error;
        const originalLog = console.log;
        const originalWarn = console.warn;
        
        console.error = function(...args) {
            addLog('CONSOLE ERROR: ' + args.join(' '), 'error');
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addLog('CONSOLE WARN: ' + args.join(' '), 'warning');
            originalWarn.apply(console, args);
        };
        
        // Auto-run diagnostics on load
        window.addEventListener('load', () => {
            setTimeout(runDiagnostics, 1000);
        });
    </script>
</body>
</html>